# Story 2.1: Content Ingestion Pipeline

## Status
Draft

## Story
**As a** system processing educational content,
**I want** a robust PDF ingestion pipeline that extracts text and creates textbook records,
**so that** I can process TBAT Physics content for chunking and vector indexing.

## Acceptance Criteria
1. PDF processing service implemented using PyMuPDF (fitz) for reliable text extraction
2. Textbook metadata processing and storage in PostgreSQL textbooks table with version tracking
3. Content validation and preprocessing including encoding verification and format checks
4. Async job creation for content processing using Celery + Redis background processing
5. Job status tracking with progress monitoring and result retrieval via job_id
6. File upload API endpoint with security validation, size limits, and error handling
7. Integration tests validate PDF extraction, metadata storage, and job processing workflow

## Tasks / Subtasks
- [ ] Implement PDF processing service (AC: 1)
  - [ ] Setup PyMuPDF (fitz) dependency in project
  - [ ] Create PDFProcessor class in processing service
  - [ ] Implement text extraction with page-level metadata
  - [ ] Add error handling for corrupted or encrypted PDFs
  - [ ] Extract document metadata (title, author, page count)

- [ ] Setup textbook metadata management (AC: 2)
  - [ ] Implement TextbookRecord model with version tracking
  - [ ] Create textbook storage methods in database service
  - [ ] Add metadata validation and normalization
  - [ ] Implement textbook indexing and lookup methods
  - [ ] Add source_data_version tracking for traceability

- [ ] Implement content validation (AC: 3)
  - [ ] Create ContentValidator class for preprocessing
  - [ ] Add UTF-8 encoding validation and conversion
  - [ ] Implement format verification (PDF structure check)
  - [ ] Add content quality checks (text extraction success rate)
  - [ ] Create preprocessing pipeline for text normalization

- [ ] Setup async job processing (AC: 4)
  - [ ] Configure Celery worker for content processing tasks
  - [ ] Create content_ingestion_task with proper error handling
  - [ ] Implement job queue management with Redis backend
  - [ ] Add task retry mechanisms with exponential backoff
  - [ ] Setup job result storage and cleanup procedures

- [ ] Implement job tracking API (AC: 5)
  - [ ] Create /status/{job_id} endpoint for progress monitoring
  - [ ] Add job progress tracking with percentage completion
  - [ ] Implement job result retrieval with status codes
  - [ ] Add job error reporting and failure details
  - [ ] Setup job cleanup and timeout handling

- [ ] Create file upload endpoint (AC: 6)
  - [ ] Implement /upload-pdf endpoint with FastAPI
  - [ ] Add file type validation (PDF only) and size limits
  - [ ] Setup secure temporary file handling
  - [ ] Implement authentication and authorization checks
  - [ ] Add comprehensive error responses and logging

- [ ] Create integration tests (AC: 7)
  - [ ] Test PDF text extraction with various document types
  - [ ] Test textbook metadata storage and retrieval
  - [ ] Test async job creation and completion workflow
  - [ ] Test file upload with valid and invalid inputs
  - [ ] Test error handling and failure scenarios

## Dev Notes

### Previous Story Insights
Built on Story 1.1 foundation with database schemas, services architecture, and Celery/Redis infrastructure already in place.

### Data Models
**Textbook Records (Source: requirements.md FR4, technical-assumptions.md):**
- **textbooks table**: Store source material metadata, version tracking, processing status
- **Fields**: textbook_id, title, author, subject, version, file_path, processing_status, created_at
- **Relationships**: Links to chunks table for processed content chunks
- **Source Tracking**: source_data_version for complete traceability

### API Specifications
**File Upload Endpoint (Source: requirements.md FR16):**
- **POST /upload-pdf**: Accept PDF file upload with metadata
- **POST /process-content**: Trigger async content processing job
- **GET /status/{job_id}**: Job progress and result retrieval
- **Authentication**: Basic API key authentication for file uploads
- **File Limits**: Max 50MB PDF files, PDF format validation required

### Component Specifications
**PDF Processing Service (Source: requirements.md FR2, technical-assumptions.md):**
- **PyMuPDF Integration**: Reliable text extraction from PDF documents
- **Text Processing**: Basic text normalization and encoding validation
- **Metadata Extraction**: Document title, author, page count, creation date
- **Error Handling**: Graceful handling of corrupted, encrypted, or invalid PDFs
- **Future Ready**: Image extraction capability for post-MVP enhancement

### File Locations
**Content Processing Components:**
- `/src/services/processing_service.py`: PDFProcessor and ContentValidator classes
- `/src/services/textbook_service.py`: TextbookRecord management and storage
- `/src/api/upload.py`: File upload endpoints and validation
- `/src/tasks/content_tasks.py`: Celery tasks for async processing
- `/tests/test_content_processing.py`: Integration and unit tests

### Testing Requirements
**Content Processing Tests (Source: requirements.md NFR14):**
- **PDF Processing**: Test text extraction with various document formats
- **File Upload**: Test security validation, size limits, error handling
- **Async Processing**: Test Celery task execution and job tracking
- **Error Scenarios**: Test corrupted files, network failures, timeout handling
- **Integration**: End-to-end content ingestion workflow validation

### Technical Constraints
**Processing Requirements (Source: technical-assumptions.md, requirements.md):**
- **File Format**: PDF only for MVP (image processing deferred to post-MVP)
- **Text Extraction**: PyMuPDF (fitz) for reliable extraction performance
- **Async Processing**: Celery + Redis for background job management
- **Storage**: Temporary file storage with automatic cleanup
- **Performance**: Process standard textbook PDFs within reasonable time limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | v1.0 | Epic 2 content ingestion story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will appear here after implementation*