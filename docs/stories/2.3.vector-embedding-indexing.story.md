# Story 2.3: Vector Embedding & Indexing

## Status
Draft

## Story
**As a** RAG retrieval system,
**I want** vector embedding generation and Qdrant indexing for content chunks,
**so that** I can enable semantic similarity search for Learning Objective generation.

## Acceptance Criteria
1. Vector embedding service integrated with bge-m3 model for multilingual content processing
2. Qdrant vector database connection and collection management for educational content
3. Chunk vector indexing with language-aware embedding routing and metadata storage
4. Vector similarity search functionality with configurable similarity thresholds
5. Async embedding generation using Celery for processing large chunk datasets
6. Vector index optimization for Physics educational content retrieval patterns
7. Integration with existing chunk storage system and metadata preservation
8. Performance validation ensuring efficient indexing and search operations

## Tasks / Subtasks
- [ ] Setup vector embedding service (AC: 1)
  - [ ] Integrate bge-m3 embedding model via Ollama local hosting
  - [ ] Create VectorEmbeddingService class in vector service
  - [ ] Implement text embedding generation with language detection
  - [ ] Add embedding dimension validation (1024 for bge-m3)
  - [ ] Setup embedding model configuration and loading
  - [ ] Add error handling for model unavailability

- [ ] Configure Qdrant integration (AC: 2)
  - [ ] Setup Qdrant client connection with proper configuration
  - [ ] Create collections for Physics content with appropriate schema
  - [ ] Implement collection management (create, delete, list operations)
  - [ ] Configure vector dimensions and distance metrics for educational content
  - [ ] Add Qdrant health checks and connection monitoring
  - [ ] Setup collection backup and restoration procedures

- [ ] Implement chunk vector indexing (AC: 3)
  - [ ] Create chunk-to-vector indexing pipeline
  - [ ] Add language-aware embedding routing (English/Thai optimization)
  - [ ] Implement metadata storage with vector entries (chunk_id, textbook_id)
  - [ ] Setup batch vector insertion for performance optimization
  - [ ] Add vector deduplication and update handling
  - [ ] Create indexing progress tracking and error reporting

- [ ] Build similarity search functionality (AC: 4)
  - [ ] Implement semantic similarity search with configurable parameters
  - [ ] Add similarity threshold configuration for relevance filtering
  - [ ] Create search result ranking and scoring system
  - [ ] Implement metadata filtering for targeted retrieval
  - [ ] Add search performance monitoring and optimization
  - [ ] Setup search result caching for frequent queries

- [ ] Configure async embedding processing (AC: 5)
  - [ ] Create embedding_task for Celery background processing
  - [ ] Implement batch embedding generation for large datasets
  - [ ] Add progress tracking for embedding job completion
  - [ ] Setup error handling and retry mechanisms for failed embeddings
  - [ ] Implement resource management for memory-intensive operations
  - [ ] Add job result aggregation and completion notifications

- [ ] Optimize vector index performance (AC: 6)
  - [ ] Configure Qdrant indexing parameters for educational content
  - [ ] Implement index partitioning strategies for large datasets
  - [ ] Add performance monitoring for search and indexing operations
  - [ ] Setup index maintenance and optimization procedures
  - [ ] Configure memory and disk usage optimization
  - [ ] Add performance benchmarking and metrics collection

- [ ] Integrate with chunk storage system (AC: 7)
  - [ ] Link vector indexing with existing chunk storage pipeline
  - [ ] Preserve chunk metadata in vector index entries
  - [ ] Implement synchronization between PostgreSQL chunks and Qdrant vectors
  - [ ] Add consistency checks and data integrity validation
  - [ ] Setup automated reindexing for updated chunks
  - [ ] Create cleanup procedures for orphaned vectors

- [ ] Create performance validation tests (AC: 8)
  - [ ] Test embedding generation speed with sample Physics content
  - [ ] Validate search performance with realistic query loads
  - [ ] Test indexing performance with ~50k chunks target dataset
  - [ ] Verify memory usage and resource consumption
  - [ ] Test concurrent indexing and search operations
  - [ ] Validate search accuracy and relevance scoring

## Dev Notes

### Previous Story Insights
Builds on Story 2.2 chunk processing with structured chunks and metadata ready for vector embedding and indexing.

### Data Models
**Vector Index Schema (Source: requirements.md FR6, technical-assumptions.md):**
- **Qdrant Collections**: Store vector embeddings with metadata for semantic search
- **Vector Dimensions**: 1024 dimensions for bge-m3 multilingual embeddings
- **Metadata Fields**: chunk_id, textbook_id, language, quality_score, topics
- **Distance Metric**: Cosine similarity for educational content matching
- **Index Optimization**: Partitioned by subject/language for search performance

### API Specifications
**Vector Search Interface (Source: requirements.md FR7, FR9):**
- **Internal API**: Vector search service for retrieval pipeline integration
- **Search Parameters**: Query text, similarity threshold, result limit, metadata filters
- **Response Format**: Ranked results with similarity scores and chunk metadata
- **Performance**: Sub-second search response for typical educational queries

### Component Specifications
**Vector Processing Architecture (Source: technical-assumptions.md):**
- **bge-m3 Embeddings**: Multilingual embedding model via Ollama local hosting
- **Qdrant Integration**: Vector database for high-performance similarity search
- **Language Routing**: Optimized embedding processing for English/Thai content
- **Batch Processing**: Efficient bulk embedding generation and indexing
- **Memory Management**: Optimized resource usage for large-scale processing

### File Locations
**Vector Processing Components:**
- `/src/services/vector_service.py`: VectorEmbeddingService and Qdrant integration
- `/src/models/vector.py`: Vector index models and search interfaces
- `/src/tasks/embedding_tasks.py`: Celery tasks for async embedding generation
- `/src/config/vector.yaml`: Vector processing and Qdrant configuration
- `/tests/test_vector_processing.py`: Vector indexing and search performance tests

### Testing Requirements
**Vector Processing Validation (Source: requirements.md NFR4, NFR10):**
- **Embedding Quality**: Test embedding generation consistency and accuracy
- **Search Performance**: Validate sub-second search with realistic query loads
- **Indexing Speed**: Test batch indexing performance with large chunk datasets
- **Memory Usage**: Monitor resource consumption during embedding generation
- **Search Accuracy**: Validate semantic similarity matching for educational content

### Technical Constraints
**Vector Processing Requirements (Source: technical-assumptions.md, requirements.md):**
- **Embedding Model**: bge-m3 for basic multilingual content processing
- **Vector Storage**: Qdrant with 1024-dimension vectors for ~50k chunks
- **Local Processing**: Ollama hosting for reduced API dependencies
- **Performance**: Efficient indexing and search for MVP development timeline
- **Language Support**: English-first with basic Thai support optimization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | v1.0 | Epic 2 vector embedding and indexing story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will appear here after implementation*